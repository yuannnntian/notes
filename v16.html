<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Beanfield Toolbox v16.8</title>
    <style>
        :root { --primary: #007aff; --bg: #f2f2f7; --card: #ffffff; --text: #1c1c1e; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 0; color: var(--text); -webkit-user-select: none; }
        .nav-tabs { position: sticky; top: 0; display: flex; background: #fff; padding: 12px; gap: 10px; z-index: 2000; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .tab-btn { flex: 1; border: none; padding: 12px 5px; border-radius: 10px; font-size: 12px; font-weight: 700; background: #efeff4; color: #8e8e93; text-transform: uppercase; }
        .tab-btn.active { background: var(--primary); color: white; }
        .page { display: none; padding: 15px; padding-bottom: 280px; }
        .page.active { display: block; }
        .card { background: var(--card); border-radius: 14px; padding: 16px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.04); }
        h3 { margin: 0 0 12px 0; font-size: 13px; color: var(--primary); text-transform: uppercase; font-weight: 700; border-bottom: 1px solid #f2f2f7; padding-bottom: 8px; }
        .field { margin-bottom: 12px; }
        label { display: block; font-size: 12px; font-weight: 600; margin-bottom: 6px; color: #3a3a3c; }
        input, textarea { width: 100%; padding: 12px; border: 1px solid #e5e5ea; border-radius: 10px; font-size: 16px; box-sizing: border-box; background: #fafafa; outline: none; }
        .total-input { background: #e1f0ff !important; border-color: #007aff !important; color: #007aff; font-weight: bold; }
        .toggle-group { display: flex; gap: 8px; margin-top: 4px; }
        .toggle-btn { flex: 1; padding: 10px; border-radius: 8px; border: 1px solid #e5e5ea; background: #fff; font-size: 14px; font-weight: 600; color: #8e8e93; text-align: center; }
        .toggle-btn.active { background: var(--primary); color: white; }
        .tag-input-wrapper { display: flex; gap: 8px; margin-bottom: 10px; }
        .tag-add-btn { background: var(--primary); color: white; border: none; border-radius: 10px; padding: 0 15px; font-size: 20px; font-weight: bold; }
        .tag-container { display: flex; flex-wrap: wrap; gap: 8px; }
        .tag { background: #e1f0ff; color: #007aff; padding: 6px 12px; border-radius: 20px; font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 6px; border: 1px solid #007aff; }
        .item-card { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f2f2f7; }
        .qty-ctrl { display: flex; align-items: center; gap: 14px; }
        .qty-btn { width: 32px; height: 32px; border-radius: 50%; border: none; background: #efeff4; color: var(--primary); font-weight: bold; font-size: 20px; }
        .footer { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); border-top: 1px solid #d1d1d6; padding: 16px; padding-bottom: calc(16px + env(safe-area-inset-bottom)); z-index: 1500; }
        .copy-main { width: 100%; border: none; padding: 16px; border-radius: 14px; font-weight: bold; font-size: 17px; color: white; background: var(--primary); }
    </style>
</head>
<body>

<div class="nav-tabs">
    <button class="tab-btn active" onclick="showPage('picker', this)">Materials</button>
    <button class="tab-btn" onclick="showPage('beanfield', this)">Beanfield Report</button>
</div>

<div id="picker" class="page active">
    <input type="text" id="matSearch" placeholder="Search SAP or Name..." onkeyup="filterMats()" style="margin-bottom:15px;">
    <div id="mat-container"></div>
</div>

<div id="beanfield" class="page">
    <div class="card">
        <h3>Technician Info</h3>
        <div style="display:flex; gap:10px;">
            <div class="field" style="flex:1;"><label>Inside Tech</label><input type="text" id="bf_in"></div>
            <div class="field" style="flex:1;"><label>Outside Tech</label><input type="text" id="bf_out"></div>
        </div>
    </div>
    
    <div class="card">
        <h3>Testing</h3>
        <div class="field">
            <label>Tests completed</label>
            <div class="toggle-group" id="bf_tests_done">
                <div class="toggle-btn" onclick="setToggle('bf_tests_done', 'Yes')">Yes</div>
                <div class="toggle-btn" onclick="setToggle('bf_tests_done', 'No')">No</div>
            </div>
        </div>
        <div class="field"><label>Ruby (riser)</label><input type="text" id="bf_ruby"></div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <div class="field"><label>Exfo</label><input type="text" id="bf_exfo" value="Yes"></div>
            <div class="field"><label>Light Meter</label><input type="text" id="bf_light" value="Yes"></div>
        </div>
        <div class="field"><label>WiFi</label><input type="text" id="bf_wifi" value="Yes"></div>
    </div>

    <div class="card">
        <h3>Equipment</h3>
        <label>Zhone Info</label>
        <input type="text" id="bf_z_loc" placeholder="Zhone Location" style="margin-bottom:5px;">
        <input type="text" id="bf_z_mac" placeholder="Zhone MAC" style="margin-bottom:5px;">
        <input type="text" id="bf_z_mod" placeholder="Zhone Model" style="margin-bottom:15px;">

        <label>Secondary Device Type</label>
        <div class="toggle-group" id="bf_router_type" style="margin-bottom:15px;">
            <div class="toggle-btn active" onclick="setRouterType('Airties')">Airties</div>
            <div class="toggle-btn" onclick="setToggle('bf_router_type', 'Beacon'); setRouterType('Beacon')">Beacon</div>
        </div>

        <label id="lbl_router_loc">Airties Location</label>
        <input type="text" id="bf_r_loc" placeholder="Location" style="margin-bottom:5px;">
        <label id="lbl_router_mac">Airties-MAC</label>
        <input type="text" id="bf_r_mac" placeholder="MAC" style="margin-bottom:5px;">
        <label id="lbl_router_mod">Airties Model</label>
        <input type="text" id="bf_r_mod" value="4960x" readonly>
    </div>

    <div class="card">
        <h3>Cabling & Marks</h3>
        <div class="field"><label>?/? lines terminated & fluked</label><input type="text" id="bf_lines"></div>
        <label>Room Locations</label>
        <div class="tag-input-wrapper">
            <input type="text" id="bf_loc_input" placeholder="e.g. Bed 1">
            <button class="tag-add-btn" onclick="addTag('bf_tags', 'bf_loc_input')">+</button>
        </div>
        <div id="bf_tags" class="tag-container" style="margin-bottom:15px;"></div>
        
        <div class="field">
            <label id="lbl_closet_advisory">Airties in closet advisory?</label>
            <div class="toggle-group" id="bf_closet">
                <div class="toggle-btn" onclick="setToggle('bf_closet', 'Yes')">Yes</div>
                <div class="toggle-btn" onclick="setToggle('bf_closet', 'No')">No</div>
                <div class="toggle-btn" onclick="setToggle('bf_closet', 'N/A')">N/A</div>
            </div>
        </div>

        <div class="field">
            <label>$100 Charge Notified?</label>
            <div class="toggle-group" id="bf_charge">
                <div class="toggle-btn" onclick="setToggle('bf_charge', 'Yes')">Yes</div>
                <div class="toggle-btn" onclick="setToggle('bf_charge', 'No')">No</div>
            </div>
        </div>
        
        <div class="field">
            <label id="lbl_reason">Reason for device in closet or no Cat5:</label>
            <textarea id="bf_reason" rows="2"></textarea>
        </div>
    </div>

    <div class="card">
        <h3>Infrastructure</h3>
        <input type="text" id="bf_fpp" placeholder="Floor/Panel/Port" style="margin-bottom:10px;">
        <label>Fiber meter marks (m)</label>
        <div style="display:flex; gap:5px; margin-bottom:10px;">
            <div style="flex:1;"><input type="number" id="bf_m_riser" placeholder="Riser" oninput="calcTotal()"></div>
            <div style="flex:1;"><input type="number" id="bf_m_suite" placeholder="Suite" oninput="calcTotal()"></div>
            <div style="flex:1;"><input type="text" id="bf_m_total" class="total-input" readonly placeholder="Total"></div>
        </div>
        <label>Hub Stock Location</label>
        <input type="text" id="bf_hub" value="2206 Eglinton Ave east">
    </div>

    <div class="card"><h3>Additional Notes</h3><textarea id="bf_notes" rows="2"></textarea></div>
</div>

<div class="footer">
    <button id="copyBtn" class="copy-main" onclick="doCopy()">Copy Materials</button>
</div>

<script>
const inventory = {
    "Frequently Used": [
        {id:"1001199", n:"4 port GPON zhone"}, {id:"1002327", n:"NEW ZHONE 2424GN"}, {id:"1002324", n:"XGS Zhone"},
        {id:"1002245", n:"GN/XGS Zhone mounts"}, {id:"1000420", n:"Zhone mounts"}, {id:"1002344", n:"Airties 4960x"},
        {id:"1002555", n:"Nokia Beacon"}, {id:"1001083", n:"LC APC connectors"}, {id:"1000526", n:"Heat sleeves"},
        {id:"1002322", n:"Fibre jacks"}, {id:"1002388", n:"APC APC Patches SC-SC"}, {id:"1000715", n:"Screws (8, 3/4)"},
        {id:"1000477", n:"Alchohol wipes"}, {id:"1000289", n:"RJ45 connectors"}, {id:"1001047", n:"2 port face plates"},
        {id:"1000520", n:"White jacks"}, {id:"-", n:"Beanfield Stickers"}, {id:"-", n:"Booties"}
    ],
    "Hardware": [
        {id:"1001087", n:"Active-e zhone"}, {id:"1002557", n:"Nokia XS-010x ONT"}, {id:"1002556", n:"Nokia XS-220x VOIP ONT"}
    ],
    "Fiber": [
        {id:"1001084", n:"SC APC connectors"}, {id:"1000422", n:"LC UPC 250/900"}, {id:"1000476", n:"SC UPC"}
    ],
    "Copper": [
        {id:"1001048", n:"4 port faceplates"}, {id:"1001049", n:"Coax connectors"}, {id:"1000254", n:"3ft cat5 patch cable"},
        {id:"1000497", n:"5ft cat5 patch cable"}, {id:"1000253", n:"10ft cat5 patch cable"}
    ],
    "OTHER": [
        {id:"1001208", n:"Power Extension"}, {id:"1000627", n:"Dry wall anchors"}, {id:"1000137", n:"Saddles (small)"},
        {id:"1000136", n:"Saddles (large)"}, {id:"1001554", n:"SML TV Box"}, {id:"1000501", n:"Phone Dongles"},
        {id:"1002407", n:"Archer C20 (100MBS)"}, {id:"1002481", n:"TP LINK ARCHER AX23 (750MBS)"}
    ]
};

let cart = {};
let toggles = { 'bf_router_type': 'Airties', 'bf_tests_done': 'Yes', 'bf_closet': 'N/A', 'bf_charge': 'No' };
let tags = { 'bf_tags': [] };

window.onload = () => { render(); };

function setRouterType(type) {
    toggles['bf_router_type'] = type;
    document.getElementById('bf_router_type').querySelectorAll('.toggle-btn').forEach(b => b.classList.toggle('active', b.innerText === type));
    document.getElementById('lbl_router_loc').innerText = type + " Location";
    document.getElementById('lbl_router_mac').innerText = type + "-MAC";
    document.getElementById('lbl_router_mod').innerText = type + " Model";
    document.getElementById('lbl_closet_advisory').innerText = type + " in closet advisory?";
    document.getElementById('bf_r_mod').value = (type === 'Beacon') ? "Beacon19" : "4960x";
}

function calcTotal() {
    const r = parseFloat(document.getElementById('bf_m_riser').value) || 0;
    const s = parseFloat(document.getElementById('bf_m_suite').value) || 0;
    document.getElementById('bf_m_total').value = Math.abs(s - r).toFixed(1);
}

function render() {
    const cont = document.getElementById('mat-container');
    cont.innerHTML = "";
    for(let cat in inventory) {
        let h = `<div class="card"><h3>${cat}</h3>`;
        inventory[cat].forEach(item => {
            const k = item.id + item.n;
            h += `<div class="item-card">
                <div><div style="font-size:14px;font-weight:600;">${item.n}</div><div style="font-size:11px;color:#8e8e93;">SAP: ${item.id}</div></div>
                <div class="qty-ctrl">
                    <button class="qty-btn" onclick="add('${item.id}','${item.n}',-1)">−</button>
                    <div style="min-width:20px; text-align:center; font-weight:700;">${cart[k]?.q || 0}</div>
                    <button class="qty-btn" onclick="add('${item.id}','${item.n}',1)">+</button>
                </div>
            </div>`;
        });
        cont.innerHTML += h + `</div>`;
    }
}

function add(id, n, d) {
    const k = id + n;
    if(!cart[k]) cart[k] = {id, n, q:0};
    cart[k].q += d;
    if(cart[k].q <= 0) delete cart[k];
    
    // --- 智能填充逻辑 (v16.8 更新) ---
    const zModInput = document.getElementById('bf_z_mod');
    if (cart[k] && cart[k].q > 0) {
        if (id === "1001199") {
            zModInput.value = "2424A1";
        } else if (id === "1002327") {
            zModInput.value = "2424gn";
        } else if (id === "1002324") {
            zModInput.value = "5222xg";
        }
    }
    
    render();
}

function filterMats() {
    let v = document.getElementById('matSearch').value.toLowerCase();
    document.querySelectorAll('.item-card').forEach(c => c.style.display = c.innerText.toLowerCase().includes(v) ? "flex" : "none");
}

function addTag(cid, iid) {
    const v = document.getElementById(iid).value.trim();
    if(v) { tags[cid].push(v); document.getElementById(iid).value=""; renderTags(cid); }
}
function removeTag(cid, i) { tags[cid].splice(i,1); renderTags(cid); }
function renderTags(cid) {
    document.getElementById(cid).innerHTML = tags[cid].map((t, i) => `<div class="tag">${t} <span onclick="removeTag('${cid}',${i})">×</span></div>`).join('');
}

function showPage(id, btn) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('copyBtn').innerText = (id === 'picker') ? "Copy Materials" : "Copy Beanfield Report";
}

function setToggle(gid, v) {
    toggles[gid] = v;
    document.getElementById(gid).querySelectorAll('.toggle-btn').forEach(b => b.classList.toggle('active', b.innerText === v));
}

function doCopy() {
    const mats = Object.values(cart).map(i => `${i.id}: ${i.n}: ${i.q}`).join('\n');
    const getV = (id) => document.getElementById(id).value || "N/A";
    const getT = (id) => toggles[id] || "N/A";

    if(document.getElementById('picker').classList.contains('active')) {
        copyToClipboard(mats || "No items selected");
    } else {
        const rType = toggles['bf_router_type'];
        let r = `Inside Tech: ${getV('bf_in')}\nOutside Tech: ${getV('bf_out')}\n\n`;
        r += `Tests completed: ${getT('bf_tests_done')}\nRuby: ${getV('bf_ruby')}\nExfo: ${getV('bf_exfo')}\nLight meter: ${getV('bf_light')}\nWiFi: ${getV('bf_wifi')}\n\n`;
        r += `Zhone Location: ${getV('bf_z_loc')}\nZhone MAC: ${getV('bf_z_mac')}\nZhone Model: ${getV('bf_z_mod')}\n\n`;
        r += `${rType} Location: ${getV('bf_r_loc')}\n${rType}-MAC: ${getV('bf_r_mac')}\n${rType} Model: ${getV('bf_r_mod')}\n\n`;
        r += `If the ${rType} was left in the closet, was the customer advised? ${getT('bf_closet')}\n\n`;
        r += `${getV('bf_lines')} lines terminated, fluked and plugged into the Zhone\n`;
        r += tags['bf_tags'].map(t => "        " + t + ": 1").join('\n') + "\n\n";
        
        r += `Was the customer notified of $100 charge for a return visit? ${getT('bf_charge')}\n\n`;
        r += `Reason for ${rType} being in the closet or not terminating Cat5s: ${getV('bf_reason')}\n\n`;
        
        r += `Floor/Panel/Port info: ${getV('bf_fpp')}\n\n`;
        r += `Fiber meter mark (in meters): Riser = ${getV('bf_m_riser')}, Suite = ${getV('bf_m_suite')}, Total = ${getV('bf_m_total')}\n\n`;
        
        r += `Hub Stock Location: ${getV('bf_hub')}\n\nMaterial list:\n${mats}\n\nAdditional notes: ${getV('bf_notes')}`;
        copyToClipboard(r);
    }
}

function copyToClipboard(t) {
    const el = document.createElement('textarea'); el.value = t; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el);
    alert("Copied to Clipboard!");
}
</script>
</body>
</html>